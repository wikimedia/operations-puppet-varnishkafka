# Note: This file is managed by Puppet.

#######################################################################
#                                                                     #
#                varnishkafka configuration file                      #
#                                                                     #
#                                                                     #
#######################################################################
#                                                                     #
# Syntax:                                                             #
# <property-name> = <value>                                           #
#                                                                     #
# Boolean property values:                                            #
#   >0, "true", "yes", "on" - interpreted as true                     #
#  everything else          - interpreted as false                    #
#                                                                     #
#######################################################################
                                                                      #
                                                                      #
                                                                      #
#######################################################################
#                                                                     #
# Varnish log formatting                                              #
#                                                                     #
# format.type - format output type, one of:                           #
#  string     - ASCII string output                                   #
#  json       - JSON output                                           #
#                                                                     #
#                                                                     #
# format - format string                                              #
#  %X                                                                 #
#   where 'X' is one of the standard varnishncsa(1) formatters.       #
#   Example: %u                                                       #
#                                                                     #
#                                                                     #
#  %{VAR}X                                                            #
#    Name-Value tokens where X is 'x', 'i' or 'o' and 'VAR' is the    #
#    Name to extract the value for.                                   #
#    Example: %{User-Agent}i                                          #
#                                                                     #
#                                                                     #
#  %{?DEFAULT@FIELD!OPTION!OPTION..}X                                 #
#    where 'X' is any formatter,                                      #
#                                                                     #
#    'DEFAULT' is the default string to use if no tag was matched,    #
#     the default default string is "-".                              #
#                                                                     #
#    'FIELD' is the field name to use with the JSON formatter.        #
#     i.e., "%{@host}l" will be JSON encoded as: {"host":"1.2.3.4"}   #
#                                                                     #
#    'OPTION' is one or more of the formatting options:               #
#        escape - escape non-printable characters to \<octalcode>     #
#                 and \t\n\r\v\f " to their canonical                 #
#                 backslashed notations (\t\n\r\v\f\"\ ).             #
#        num    - for typed formatters, such as JSON, try to encode   #
#                 the value as a number.                              #
#                                                                     #
#                                                                     #
#    This syntax can be combined with %{VAR}X.                        #
#    Example: %{User-Agent?Mozilla!escape}i                           #
#             %{?nouser}u                                             #
#             %{!escape}q                                             #
#             %{@host}l                                               #
#                                                                     #
#                                                                     #
#                                                                     #
#  Additional formatter specials:                                     #
#    %{<strftime-format>}t - format timestamp according to supplied   #
#                            strftime(3) compatible format string.    #
#                                                                     #
#                                                                     #
#                                                                     #
#  Non %-prefixed strings are copied verbatim to the                  #
#  output log string.                                                 #
#    Example: "User: %u;"   would render "User: snaps;"               #
#                                                                     #
#                                                                     #
#######################################################################

# Where to output varnish log lines:
#  kafka  - (default) send to kafka broker
#  stdout - just print to stdout (behave like varnishncsa)
#  null   - (test) collect all tags specified by format but dont output anything
output = <%= @output %>

# Log formatter
format.type = <%= @format_type %>
format = <%= @format %>

# Optional secondary formatting.
#   'output = kafka':  The rendered 'format.key' will be provided as the
#                      Kafka message Key
#   'output = string': Print string to stdout.
# Supports the same formating and type as 'format' and 'format.type'.
#
<% if @format_key -%>
format.key.type = <%= @format_key_type %>
format.key = <%= @format_key %>
<% else -%>
# format.key.type = <%= @format_key_type %>
# format.key = %h
<% end -%>



# EXPERIMENTAL
# Indicates if the log tag data read from VSL files should be copied instantly
# when read (true). If this is set to false the data is assumed to be
# persistent (for the duration of collecting and formatting a single request)
# and no copies will be made, thus improving performance.
#
# NOTE:
#   Must be set to true for offline files (-r file..) due to the way
#   libvarnishapi reads its data.
log.data.copy = <%= @log_data_copy %>


# Start for sequence number (%n)
# Either a number, or the string "time" which will set it to the current
# unix time in seconds multiplied by 1,000,000.
# Defaults to 0.
sequence.number = <%= @sequence_number %>

# FUTURE: read last sequence number from file to allow restarts
#sequence.file = /var/spool/varnishkafka.seq


#
# varnishkafka log messages configuration
# Debugging, error reporting, etc, not to be confused with varnish logs.
#

# varnishkafka log level (1 = emergencies .. 7 = debug)
log.level = <%= @log_level %>

# specify log output (multiples allowed)
log.stderr = <%= @log_stderr %>
log.syslog = <%= @log_syslog %>>



# daemonize varnishkafka (boolean)
daemonize = true


#######################################################################
#                                                                     #
# Standard varnish VSL command line arguments                         #
#                                                                     #
# Syntax:                                                             #
#  varnish.arg.<c> = <value>, where <c> is a command line option.     #
#                                                                     #
# See varnishncsa(1) and varnishlog(1) for valid options.             #
#                                                                     #
#######################################################################


<% @varnish_opts.each_pair do |option, value| -%>
# -<%= option %> <%= value %>
varnish.arg.<%= option %> = <%= value %>
<% end -%>

<% if @output == 'kafka' -%>
#######################################################################
#                                                                     #
# Kafka configuration                                                 #
#                                                                     #
# For the full range of Kafka handle and topic configuration          #
# properties, see:                                                    #
#  https://github.com/edenhill/librdkafka/blob/0.8-wip/rdkafka.h      #
#                                                                     #
# And the Apache Kafka configuration reference:                       #
#  http://kafka.apache.org/08/configuration.html                      #
#                                                                     #
#######################################################################

# Initial list of kafka brokers
metadata.broker.list = <%= Array(@brokers).join(',') %>

# Maximum number of messages allowed on the local producer queue
queue.buffering.max.messages = <%= @queue_buffering_max_messages %>

# Maximum number of retries per messageset.
message.send.max.retries = <%= @message_send_max_retries %>

# Topic to produce messages to
topic = <%= @topic %>

# Partition (-1: random, else one of the available partitions)
partition = <%= @partition %>

# Required number of acks
topic.request.required.acks = <%= @topic_request_required_acks %>

# Local message timeout (milliseconds)
topic.message.timeout.ms = <%= topic_message_timeout_ms %>

<% end -%>
